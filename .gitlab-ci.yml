stages:
  - build
  - release
  - internal_release
  - beta_release
  - production_release

variables:
  ANDROID_SDK_ROOT: "/opt/android-sdk-linux"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  PLAY_STAGED_PERCENT: "0.2"
  GIT_DEPTH: "0"

cache:
  key: ${CI_PROJECT_NAME}
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - android/app/build

.build_template: &build_template
  image: ghcr.io/cirruslabs/android-sdk:36
  before_script:
    - |
      if [ -n "$ANDROID_UPLOAD_KEYSTORE_B64" ] && [ -z "$ANDROID_UPLOAD_KEYSTORE" ]; then
        mkdir -p android
        echo "$ANDROID_UPLOAD_KEYSTORE_B64" | base64 -d > android/upload-keystore.jks
        export ANDROID_UPLOAD_KEYSTORE="$PWD/android/upload-keystore.jks"
      fi
    - cd android
    - chmod +x gradlew
  artifacts:
    paths:
      - android/app/build/outputs/

.publish_template: &publish_template
  <<: *build_template
  before_script:
    - |
      if [ -n "$ANDROID_UPLOAD_KEYSTORE_B64" ] && [ -z "$ANDROID_UPLOAD_KEYSTORE" ]; then
        mkdir -p android
        echo "$ANDROID_UPLOAD_KEYSTORE_B64" | base64 -d > android/upload-keystore.jks
        export ANDROID_UPLOAD_KEYSTORE="$PWD/android/upload-keystore.jks"
      fi
      if [ -n "$PLAY_SERVICE_ACCOUNT_JSON_B64" ] && [ -z "$PLAY_SERVICE_ACCOUNT_JSON" ]; then
        echo "$PLAY_SERVICE_ACCOUNT_JSON_B64" | base64 -d > service-account.json
        export PLAY_SERVICE_ACCOUNT_JSON="$PWD/service-account.json"
      fi
    - cd android
    - chmod +x gradlew

build_aab:
  stage: build
  <<: *build_template
  script:
    - ./gradlew --no-daemon bundleProdRelease
  artifacts:
    paths:
      - android/app/build/outputs/bundle/prodRelease/
    expire_in: 1 week
  rules:
    - when: always

semver-tag:
  stage: release
  image: alpine:3.19
  before_script:
    - apk add --no-cache git curl bash
  script:
    - chmod +x scripts/bump-version.sh scripts/generate-changelog.sh
    - VERSION=$(scripts/bump-version.sh)
    - echo "$VERSION" > version.txt
    - scripts/generate-changelog.sh "$VERSION" > changelog.md
    - |
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@example.com}"
      git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"
    - git tag -a "$VERSION" -m "Release $VERSION"
    - |
      PUSH_USER="${GIT_PUSH_USER:-gitlab-ci-token}"
      PUSH_TOKEN="${GIT_PUSH_TOKEN:-$CI_JOB_TOKEN}"
      if git push "https://${PUSH_USER}:${PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$VERSION"; then
        echo "Tag push succeeded: $VERSION"
      else
        echo "WARN: Tag push failed. Set GIT_PUSH_TOKEN with tag permissions. Falling back to pipeline version."
        VERSION="v0.0.${CI_PIPELINE_IID:-1}"
        echo "$VERSION" > version.txt
      fi
    - |
      if [ -n "${GL_RELEASE_TOKEN:-}" ]; then
        curl --header "PRIVATE-TOKEN: ${GL_RELEASE_TOKEN}" \
          --data-urlencode "name=$VERSION" \
          --data-urlencode "tag_name=$VERSION" \
          --data-urlencode "description=$(cat changelog.md)" \
          --request POST "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases" || echo "WARN: GitLab release creation failed."
      fi
  artifacts:
    paths:
      - version.txt
      - changelog.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success

internal_release:
  stage: internal_release
  <<: *publish_template
  needs:
    - job: semver-tag
      artifacts: true
  variables:
    PLAY_TRACK: "internal"
    PLAY_RELEASE_STATUS: "completed"
  script:
    - VERSION=$(cat ../version.txt)
    - export VERSION_NAME="${VERSION#v}"
    - ./gradlew --no-daemon publishProdReleaseBundle
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success

beta_release:
  stage: beta_release
  <<: *publish_template
  needs:
    - job: internal_release
      artifacts: false
    - job: semver-tag
      artifacts: true
  variables:
    PLAY_TRACK: "beta"
    PLAY_RELEASE_STATUS: "completed"
  when: manual
  script:
    - VERSION=$(cat ../version.txt)
    - export VERSION_NAME="${VERSION#v}"
    - ./gradlew --no-daemon publishProdReleaseBundle
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual

production_release:
  stage: production_release
  <<: *publish_template
  needs:
    - job: semver-tag
      artifacts: true
  variables:
    PLAY_TRACK: "production"
    PLAY_USER_FRACTION: $PLAY_STAGED_PERCENT
  when: manual
  allow_failure: false
  script:
    - VERSION=$(cat ../version.txt)
    - export VERSION_NAME="${VERSION#v}"
    - export PLAY_RELEASE_STATUS="inprogress"
    - ./gradlew --no-daemon publishProdReleaseBundle
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
