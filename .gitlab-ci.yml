image: eclipse-temurin:17-jdk

variables:
  ANDROID_SDK_ROOT: "$CI_PROJECT_DIR/.android-sdk"
  ANDROID_HOME: "$ANDROID_SDK_ROOT"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

stages:
  - build
  - deploy
  - k8s-deploy

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .gradle/wrapper
    - .gradle/caches

before_script:
  - apt-get update -qq
  - apt-get install -yq wget unzip
  - mkdir -p "$ANDROID_SDK_ROOT"
  - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
  - unzip -q /tmp/cmdline-tools.zip -d "$ANDROID_SDK_ROOT"
  - mv "$ANDROID_SDK_ROOT/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools-temp"
  - mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
  - mv "$ANDROID_SDK_ROOT/cmdline-tools-temp"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
  - |
    set +o pipefail
    yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" "platforms;android-34" "platform-tools" "build-tools;34.0.0"
  - |
    set +o pipefail
    yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses --sdk_root="$ANDROID_SDK_ROOT"
  - export PATH="$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"

build_debug_apk:
  stage: build
  script:
    - cd android
    - ./gradlew --no-daemon assembleDebug
    - mkdir -p ../dist
    - cp app/build/outputs/apk/debug/app-debug.apk ../dist/schautrack-debug.apk
  artifacts:
    name: "schautrack-debug-apk"
    paths:
      - dist/schautrack-debug.apk
    expire_in: 1 week

pages:
  stage: deploy
  needs:
    - job: build_debug_apk
      artifacts: true
  script:
    - mkdir -p public
    - cp dist/schautrack-debug.apk public/
    - |
      cat > public/index.html <<'HTML'
      <!doctype html>
      <html lang="en">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <title>Schautrack APK</title>
        <style>
          body { font-family: system-ui, -apple-system, Segoe UI, sans-serif; margin: 2rem; color: #111; }
          .card { max-width: 480px; padding: 1.5rem; border: 1px solid #ddd; border-radius: 12px; box-shadow: 0 6px 22px rgba(0,0,0,0.06); }
          .btn { display: inline-block; margin-top: 1rem; padding: 0.75rem 1.25rem; background: #4F46E5; color: #fff; text-decoration: none; border-radius: 8px; font-weight: 600; }
          .meta { margin-top: 0.75rem; color: #555; font-size: 0.9rem; }
        </style>
      </head>
      <body>
        <div class="card">
          <h1>Schautrack APK</h1>
          <p>Download the latest debug build.</p>
          <a class="btn" href="./schautrack-debug.apk" download>Download APK</a>
          <div class="meta">File: schautrack-debug.apk</div>
        </div>
      </body>
      </html>
      HTML
  artifacts:
    paths:
      - public
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'

deploy_k8s:
  stage: k8s-deploy
  image:
    name: bitnami/kubectl:1.30
    entrypoint: [""]
  needs:
    - job: build_debug_apk
      artifacts: true
  variables:
    K8S_MANIFESTS_DIR: "k8s"
  script:
    - 'test -n "${KUBECONFIG_DATA:-}" || (echo "KUBECONFIG_DATA missing" && exit 1)'
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
    - kubectl config set-context --current --namespace="${KUBE_NAMESPACE:-default}" || true
    - kubectl version --short
    - 'test -d "$K8S_MANIFESTS_DIR" || (echo "Manifests dir $K8S_MANIFESTS_DIR not found" && exit 1)'
    - kubectl apply -f "$K8S_MANIFESTS_DIR"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main" && $KUBECONFIG_DATA'
      when: on_success
