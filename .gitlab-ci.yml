image: eclipse-temurin:17-jdk

variables:
  ANDROID_SDK_ROOT: "$CI_PROJECT_DIR/.android-sdk"
  ANDROID_HOME: "$ANDROID_SDK_ROOT"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - .gradle/wrapper
    - .gradle/caches

stages:
  - build

before_script:
  - apt-get update -qq
  - apt-get install -yq wget unzip
  - mkdir -p "$ANDROID_SDK_ROOT"
  - wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O /tmp/cmdline-tools.zip
  - unzip -q /tmp/cmdline-tools.zip -d "$ANDROID_SDK_ROOT"
  - mv "$ANDROID_SDK_ROOT/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools-temp"
  - mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
  - mv "$ANDROID_SDK_ROOT/cmdline-tools-temp"/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
  - |
    set +o pipefail
    yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --sdk_root="$ANDROID_SDK_ROOT" "platforms;android-34" "platform-tools" "build-tools;34.0.0"
  - |
    set +o pipefail
    yes | "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" --licenses --sdk_root="$ANDROID_SDK_ROOT"
  - export PATH="$ANDROID_SDK_ROOT/platform-tools:$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH"

build_debug_apk:
  stage: build
  script:
    - cd android
    - ./gradlew --no-daemon assembleDebug
    - mkdir -p ../dist
    - cp app/build/outputs/apk/debug/app-debug.apk ../dist/schautrack-debug.apk
  artifacts:
    name: "schautrack-debug-apk"
    paths:
      - dist/schautrack-debug.apk
    expire_in: 1 week
