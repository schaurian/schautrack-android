stages:
  - release
  - staged_release
  - production_release

variables:
  ANDROID_SDK_ROOT: "/sdk"
  GRADLE_USER_HOME: "${CI_PROJECT_DIR}/.gradle"
  PLAY_TRACK_TEST: "internal"
  PLAY_TRACK_PROD: "production"
  PLAY_STAGED_PERCENT: "0.2"
  GIT_DEPTH: "0"

cache:
  key: ${CI_PROJECT_NAME}
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - android/app/build

.publish_template: &publish_template
  image: registry.gitlab.com/gitlab-org/ci-cd/android-sdk:api-34
  before_script:
    - |
      if [ -n "$ANDROID_UPLOAD_KEYSTORE_B64" ] && [ -z "$ANDROID_UPLOAD_KEYSTORE" ]; then
        mkdir -p android
        echo "$ANDROID_UPLOAD_KEYSTORE_B64" | base64 -d > android/upload-keystore.jks
        export ANDROID_UPLOAD_KEYSTORE="$PWD/android/upload-keystore.jks"
      fi
    - cd android
    - chmod +x gradlew
  artifacts:
    paths:
      - android/app/build/outputs/

semver-tag:
  stage: release
  image: alpine:3.19
  before_script:
    - apk add --no-cache git curl bash
  script:
    - chmod +x scripts/bump-version.sh scripts/generate-changelog.sh
    - VERSION=$(scripts/bump-version.sh)
    - echo "$VERSION" > version.txt
    - scripts/generate-changelog.sh "$VERSION" > changelog.md
    - |
      git config --global user.email "${GITLAB_USER_EMAIL:-ci@example.com}"
      git config --global user.name "${GITLAB_USER_NAME:-GitLab CI}"
    - git tag -a "$VERSION" -m "Release $VERSION"
    - |
      PUSH_USER="${GIT_PUSH_USER:-gitlab-ci-token}"
      PUSH_TOKEN="${GIT_PUSH_TOKEN:-$CI_JOB_TOKEN}"
      git push "https://${PUSH_USER}:${PUSH_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git" "$VERSION"
    - |
      if [ -n "${GL_RELEASE_TOKEN:-}" ]; then
        curl --header "PRIVATE-TOKEN: ${GL_RELEASE_TOKEN}" \
          --data-urlencode "name=$VERSION" \
          --data-urlencode "tag_name=$VERSION" \
          --data-urlencode "description=$(cat changelog.md)" \
          --request POST "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/releases"
      fi
  artifacts:
    paths:
      - version.txt
      - changelog.md
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success

staged_release:
  stage: staged_release
  <<: *publish_template
  needs:
    - job: semver-tag
      artifacts: true
  variables:
    PLAY_TRACK: $PLAY_TRACK_TEST
    PLAY_RELEASE_STATUS: "completed"
  script:
    - VERSION=$(cat version.txt)
    - export VERSION_NAME="${VERSION#v}"
    - ./gradlew --no-daemon publishReleaseBundle
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: on_success

production_release:
  stage: production_release
  <<: *publish_template
  needs:
    - job: semver-tag
      artifacts: true
  variables:
    PLAY_TRACK: $PLAY_TRACK_PROD
    PLAY_RELEASE_STATUS: "inprogress"
    PLAY_USER_FRACTION: $PLAY_STAGED_PERCENT
  when: manual
  allow_failure: false
  script:
    - VERSION=$(cat version.txt)
    - export VERSION_NAME="${VERSION#v}"
    - ./gradlew --no-daemon publishReleaseBundle
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      when: manual
